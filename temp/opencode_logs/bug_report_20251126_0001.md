# Bug Report — opencode invocation and wrapper issues (2025-11-26)

Summary
-------
- I ran a live wrapper invocation of `scripts/send_prompt_opencode.py` (1 retry) to reproduce the opencode/direct flow and collect logs.
- Result: the wrapper fell back to the direct Python add script (`add_exercise_simple.py`) because the `opencode` CLI call returned a non-zero exit code and printed its help text.

Artifacts
---------
- Session log: `temp/opencode_logs/send_prompt/session_1764194777.json`
- Opencode run stdout: `temp/opencode_logs/send_prompt/attempt_1_1764194773/run_1764194773/stdout.txt`
- Direct run stdout: `temp/opencode_logs/send_prompt/attempt_1_1764194773/run_1764194776/stdout.txt`

Relevant outputs (evidence)
--------------------------
- `opencode` stdout (truncated):

```
opencode run [message..]

run opencode with a message

Positionals:
  message  message to send                                 [array] [default: []]

Options:
  -h, --help        show help                                          [boolean]
  -v, --version     show version number                                [boolean]
  ...
  --agent       agent to use                                        [string]
```

- Direct run stdout:

```
SUCCESS: MAT_P4FUNCOE_0IX_PIX_004
```

Diagnosis / Root causes
-----------------------
1) Incorrect `opencode` CLI usage
   - The wrapper invoked `opencode run --prompt "..." --agent Exercise-Creator`.
   - The `opencode` CLI's `run` command expects the message as a positional argument (or different flag), not `--prompt` (help text shows `message` positional and no `--prompt` option), so the CLI printed help and returned non-zero.
   - Evidence: `opencode` printed usage text (help) and returned `returncode: 1` in `session_1764194777.json`.

2) Script import behavior when executed as a file
   - Running `python scripts/send_prompt_opencode.py` initially errored with `ModuleNotFoundError: No module named 'scripts'` because Python sets `sys.path[0]` to the script's directory when invoking a file by path, making package-relative imports fail.
   - Workarounds used during debugging: added `scripts/__init__.py` and ran the wrapper via `python -m scripts.send_prompt_opencode ...` so package imports resolve. Two options to avoid this in future:
     - Use relative imports inside `scripts/send_prompt_opencode.py` (e.g., `from .opencode_logging import ...`) and run as module, or
n    - Keep `scripts` a package and document `python -m scripts.send_prompt_opencode` usage.

Other notes
-----------
- PowerShell quoting issues (expansion of `$`) were handled by using single quotes around the LaTeX statement in the command; the wrapper converts newlines to spaces and passes statement safely.
- The direct fallback path works and created an exercise `MAT_P4FUNCOE_0IX_PIX_004`.

Recommendations / Fixes
-----------------------
1) Fix `run_opencode_prompt` argument construction in `scripts/send_prompt_opencode.py`:
   - Replace `['opencode', 'run', '--prompt', prompt_text, '--agent', agent]`
   - With `['opencode', 'run', prompt_text, '--agent', agent]` (put prompt as positional). Optionally also add `--format json` to parse machine-readable output if the CLI supports it.

2) Make `scripts` import robust:
   - Change imports to use relative imports inside package (e.g., in `send_prompt_opencode.py` use `from .opencode_logging import ...`) and ensure the module is executed with `python -m scripts.send_prompt_opencode`.
   - Or modify the script to insert repo root into `sys.path` at runtime (less ideal), or keep `__init__.py` and document `python -m` usage.

3) Add an automated check in the wrapper to detect the CLI printed usage/help and treat it as a specific error (help output often contains lines like `Positionals:` or `Options:`). Log this explicitly as `cli_arg_error` to make diagnosis faster.

4) Add a `--dry-run` flag to the wrapper to allow testing opencode invocation without fallback/direct creation; useful for debugging CLI-only behavior.

Next steps I can take
---------------------
- I can implement the `--dry-run` flag and the `opencode` argument fix, re-run the wrapper, and verify the opencode path succeeds (or produces better error messages).
- I can open a small patch to `scripts/send_prompt_opencode.py` to adjust the opencode args and add explicit detection of help output — if you want I can apply that now and run a dry-run.


If you want, I will now: (choose)
- A: Apply the CLI-arg fix + add `--dry-run`, then run a dry-run (no exercise creation). Recommended prior to further live runs.
- B: Apply the fix and run a live-run (may create an exercise).
- C: Stop and just have you inspect these logs.
